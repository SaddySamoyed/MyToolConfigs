# 双系统维护

说是双系统维护, 但是其实是单方面地阻止 windows 伤害我的 Ubuntu...

Ubuntu 不会影响 windows. 只有 windows 会因为逆天更新影响 Ubuntu. 

Ubuntu 的好处在用过之后真的深切感受到.. 

- 作为 linux kernel 为内核的系统, 首先性能优化从底层逻辑上远胜于 win. (比如说 process 创建逻辑)
- 对 GPU 的利用更好, ml 时间更短点
- 平时不跑大量计算的时候非常安静... (和第一点密切相关) 不插电时跟 mac 一样. 不会吹大风不会发烫, 简直就是 linux os 版的 macbook
- command line 的支持完胜 win.

以 rog 幻 14 的薄度来看, 它真的可以当 macbook 用, 而且 cli 比 macbook 的 cli 系统更好. 所以现在 Ubuntu 才是亲女儿,, win11 你不要伤害它 







## 1. 锁住 EFI 与引导

Ubuntu 的 GRUB 通常安装在 EFI 分区（`/boot/efi`）中，而 Windows 更新 (尤其是 Feature Update 或 Bootloader 修复) 可能会覆盖它

EFI 是这样的:

```
/EFI/
 ├── Microsoft/
 │    ├── Boot/
 │    │    └── bootmgfw.efi
 │    └── ...
 ├── ubuntu/
 │    ├── grubx64.efi
 │    └── shimx64.efi
 ├── Boot/
 │    └── bootx64.efi
```



**防御措施：**

1. **在 Windows 中关闭快速启动 (Fast Startup)**
     它会锁定 EFI 分区, 导致 Ubuntu 无法正常写入
     操作路径：

     ```
     控制面板 → 电源选项 → 选择电源按钮的功能 → 更改当前不可用的设置
     ```

     然后取消勾选：

     ```
     启用快速启动 (推荐)
     ```

2. **关闭 Windows 自动修复引导**
     在管理员 PowerShell 中执行：

     ```
     bcdedit /set {current} recoveryenabled No
     bcdedit /set {default} bootstatuspolicy ignoreallfailures
     ```

     这可以防止它在检测到“引导问题”时, 擅自重写 EFI.





## 2. 关闭 Windows 自动更新 (彻底)

Windows 11 的自动更新特别喜欢重建 Boot Manager

关掉它..

1. 通过注册表彻底关闭：

    ```shell
    reg add "HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\WindowsUpdate\AU" /v NoAutoUpdate /t REG_DWORD /d 1 /f
    ```



## 3. 防止 Windows 篡改 Linux 分区

Windows 有时会在“磁盘管理”中自动挂载 ext4 分区 (特别是新版的 WSL)：

1. 禁止自动挂载 Linux 分区：
     在管理员 PowerShell：

    ```
    reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\fs_rec" /v Start /t REG_DWORD /d 4 /f
    ```

    这样 Windows 就不会尝试识别 ext4。

2. 如果你需要访问 Ubuntu 文件，用 **ext4fsd**、**Linux File Systems for Windows by Paragon** 等工具时要谨慎，它们有写入权限，可能破坏超级块



## 4. 关闭 Windows 的“混合休眠”

混合休眠 (Hybrid Sleep) 会导致 EFI 和分区状态不一致。
 命令关闭：

```
powercfg /hibernate off
```









## 恢复备份的 GRUB

如果哪天 Windows 把 GRUB 干掉了：

1. 用 Ubuntu Live USB 启动

2. 挂载系统分区：

    ```shell
    sudo mount /dev/nvme0n1p6 /mnt     # Ubuntu root 分区
    sudo mount /dev/nvme0n1p1 /mnt/boot/efi   # EFI 分区
    sudo grub-install --boot-directory=/mnt/boot /dev/nvme0n1
    sudo update-grub
    ```









## 备份当前的 EFI 分区 

### 创造备份

在 Ubuntu 里面:

```shell
sudo cp -r /boot/efi /home/$USER/efi-backup
```

然后拷到外部硬盘或 U 盘. 

一旦 Windows 更新破坏了 GRUB，可直接用 live USB 恢复



下面是拷贝到 U 盘的操作指南:

### 拷贝备份进 U 盘

```shell
sudo cp -r /boot/efi /home/$USER/efi-backup
```

我们 

```shell
lsblk
```

来查看硬盘的名称. 这里结果是:

```
NAME        MAJ:MIN RM   SIZE RO TYPE MOUNTPOINTS
loop0         7:0    0     4K  1 loop /snap/bare/5
loop1         7:1    0 401.5M  1 loop /snap/blender/6559
loop2         7:2    0   2.1G  1 loop /snap/clion/385
loop3         7:3    0  63.8M  1 loop /snap/core20/2669
loop4         7:4    0  73.9M  1 loop /snap/core22/2045
loop5         7:5    0  73.9M  1 loop /snap/core22/2133
loop6         7:6    0  66.8M  1 loop /snap/core24/1196
loop7         7:7    0 114.1M  1 loop /snap/discord/256
loop8         7:8    0 245.1M  1 loop /snap/firefox/6565
loop9         7:9    0 247.6M  1 loop /snap/firefox/6966
loop10        7:10   0  11.1M  1 loop /snap/firmware-updater/167
loop11        7:11   0   516M  1 loop /snap/gnome-42-2204/202
loop12        7:12   0 516.2M  1 loop /snap/gnome-42-2204/226
loop13        7:13   0 618.3M  1 loop /snap/gnome-46-2404/125
loop14        7:14   0  91.7M  1 loop /snap/gtk-common-themes/1535
loop15        7:15   0 141.3M  1 loop /snap/mc-installer/638
loop16        7:16   0 290.8M  1 loop /snap/mesa-2404/912
loop17        7:17   0 958.7M  1 loop /snap/pycharm-community/534
loop18        7:18   0     2G  1 loop /snap/rider/638
loop19        7:19   0  10.8M  1 loop /snap/snap-store/1270
loop20        7:20   0  49.3M  1 loop /snap/snapd/24792
loop21        7:21   0  50.8M  1 loop /snap/snapd/25202
loop22        7:22   0   576K  1 loop /snap/snapd-desktop-integration/315
loop23        7:23   0  64.7M  1 loop /snap/sublime-text/217
loop24        7:24   0 140.9M  1 loop /snap/typora/106
sda           8:0    1  57.8G  0 disk 
└─sda1        8:1    1  57.7G  0 part /media/qiulin/USB DISK
nvme0n1     259:0    0 953.9G  0 disk 
├─nvme0n1p1 259:1    0   200M  0 part /boot/efi
├─nvme0n1p2 259:2    0    16M  0 part 
├─nvme0n1p3 259:3    0 499.3G  0 part 
├─nvme0n1p4 259:4    0   735M  0 part 
└─nvme0n1p5 259:5    0 453.7G  0 part /
```

说明

- **U 盘设备是 `/dev/sda1`**
- 系统已经 **自动挂载** 在 `/media/qiulin/USB DISK`

接下来只需要复制：

```shell
sudo cp -r /home/$USER/efi-backup "/media/$USER/USB DISK/"
```

复制完成后，可以验证：

```
ls "/media/$USER/USB DISK/efi-backup"
```

如果能看到 `EFI` 就成功.

然后 quit 这个 U 盘. 然后 

```shell
sudo umount "/media/$USER/USB DISK"
```

即可安全拔出.





### 如果开机发现自动启动了 win 不要惊慌, 是他改了 EFI 的 boot priority

打开 bios 改回来就好.